# Dev Protocol 2026-02-24

## Zusammenfassung
- P1-Korrekturen zur Laufzeitstabilität und Home-Assistant-API-Kompatibilität umgesetzt.
- Pending-State-Bereinigung für Passive-Mode-Logik vereinheitlicht.
- RMW-Logik konsolidiert und Options-Flow vereinfacht (P2).

## Änderungen im Detail

### 1) Import-sichere Typannotation in Unload
- **Datei:** `custom_components/saj_h2_modbus/__init__.py`
- **Problem:** Die Typannotation `SAJModbusHub | None` im Unload konnte je nach Umgebung zu einem `NameError` beim Import führen.
- **Änderung:** Typannotation entfernt, um Importfehler auszuschließen. Funktionalität unverändert.

### 2) Fast-Poll Sensoren: HA-API-kompatibles Update
- **Datei:** `custom_components/saj_h2_modbus/sensor.py`
- **Problem:** Nutzung von `self.enabled` und `self.force_update` ist nicht zuverlässig über HA-Versionen hinweg.
- **Änderung:**
  - Ersetzt durch `registry_entry.disabled` zur Aktivitätsprüfung.
  - `force_update` wird über `_attr_force_update` abgeleitet.
  - Ergebnis: Stabilere Updates ohne Attribute-Fehler.

### 3) Pending-State Cleanup für Passive Mode
- **Datei:** `custom_components/saj_h2_modbus/charge_control.py`
- **Problem:** Unterschiedliche Pending-Flag-Namen konnten zu hängenbleibenden UI-Zuständen führen.
- **Änderung:**
  - `_clear_pending_state()` behandelt nun `passive_mode` und `passive_charge_enable` konsistent.
  - Ergebnis: Zuverlässiges Löschen der Pending-Flags nach State-Änderungen.

### 4) RMW-Konsolidierung über Hub
- **Datei:** `custom_components/saj_h2_modbus/charge_control.py`
- **Problem:** Doppelte Read-Modify-Write-Logik in Hub und Charge-Control führte zu Redundanz und potenzieller Drift.
- **Änderung:** `_modify_register()` delegiert jetzt an `merge_write_register()` im Hub.
- **Ergebnis:** Einheitlicher Locking- und Fehlerpfad für RMW-Operationen.

### 5) Options-Flow vereinfacht
- **Datei:** `custom_components/saj_h2_modbus/config_flow.py`
- **Problem:** Options-Flow aktualisierte ConfigEntry-Daten doppelt und parallel zum Update-Listener.
- **Änderung:** Direkte `async_update_entry`-Schreiblogik entfernt, nur noch Options-Entry-Update.
- **Ergebnis:** Ein konsistenter Update-Pfad ohne Doppel-Apply.

## Betroffene Dateien
- `custom_components/saj_h2_modbus/__init__.py`
- `custom_components/saj_h2_modbus/sensor.py`
- `custom_components/saj_h2_modbus/charge_control.py`
- `custom_components/saj_h2_modbus/config_flow.py`
- `CHANGELOG.md`
