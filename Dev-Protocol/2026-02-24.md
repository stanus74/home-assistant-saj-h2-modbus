# Dev-Protokoll 2026-02-24

## Kontext
- Repo: home-assistant-saj-h2-modbus
- Branch: improve-feb-v1
- Fokus: Backend Audit Plan P2.1 (RMW Konsolidierung) + P2.2 (Options-Update-Flow)

## Aenderungen

### P2.1 Read-Modify-Write (RMW) vereinheitlicht
- `custom_components/saj_h2_modbus/charge_control.py`
  - Slot-Updates (time_enable + day_mask/power) nutzen jetzt durchgaengig `SAJModbusHub.merge_write_register()`.
  - Duplizierte RMW-Implementierung `_modify_register()` entfernt.

- `custom_components/saj_h2_modbus/hub.py`
  - `merge_write_register()` nutzt fuer nicht-merge-locked Register jetzt eigene per-address Locks (`_rmw_locks`).
  - Verhindert Lock-Reentry/Deadlock, da `_write_register()` intern ohnehin den Write-Lock nutzt.

### P2.2 Options-Update-Flow vereinfacht
- `custom_components/saj_h2_modbus/config_flow.py`
  - Options-Flow updated den Hub nicht mehr direkt und schreibt nicht mehr in `config_entry.data`.
  - Einzige Quelle fuer Aenderungen sind `entry.options` + Update-Listener (`async_update_options`).
  - Duplicate-host detection nutzt jetzt `get_config_value()` (options -> data).

### Scan-Interval Update greift sofort
- `custom_components/saj_h2_modbus/hub.py`
  - Beim Aendern von `scan_interval` wird der `DataUpdateCoordinator` explizit neu geschedult (unsubscribe + schedule refresh).
  - Danach `async_request_refresh()`, damit die neue Taktung sofort wirksam ist.

## Doku
- `CHANGELOG.md`
  - Eintrag fuer `v2.8.3` ergaenzt (RMW Konsolidierung, Options-Drift, Host-Check, Locking-Fix).

## Verifikation
- Lokal: `python -m compileall -q custom_components/saj_h2_modbus`
- HA-Log: "Updating scan interval: ... -> ...s" erscheint nach Options-Update.

## Hinweise / Next
- Beobachten, ob Fast-Loop Start-Logs bei mehrfachen Options-Aenderungen doppelt erscheinen (sollte nur Neustart bedeuten, kein doppelter Loop).

## P3 Cleanup

### Unused / Dead Code
- `custom_components/saj_h2_modbus/hub.py`
  - Entfernt: `_fast_debug_log_next` (ungenutzt)
- `custom_components/saj_h2_modbus/charge_control.py`
  - Entfernt: `HANDLER_RETRY_DELAY` (ungenutzt)

### Sprache / Wording vereinheitlicht (DE -> EN)
- `custom_components/saj_h2_modbus/charge_control.py`: Kommentare fuer AppMode-Entscheidung
- `custom_components/saj_h2_modbus/services.py`: MQTT Fallback-Warnungen
- `custom_components/saj_h2_modbus/modbus_utils.py`: Logging-Toggles Kommentare
- `custom_components/saj_h2_modbus/modbus_readers.py`: Kommentar zu statischen Maps
- `custom_components/saj_h2_modbus/__init__.py`: kurzer Kommentar in `_create_hub`

### Doku
- `CHANGELOG.md`
  - Ergaenzt unter `Unreleased -> Changed`: Code Cleanup / Wording
