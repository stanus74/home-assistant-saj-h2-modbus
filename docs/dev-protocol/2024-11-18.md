# Development Protocol - 2024-11-18

## PR #121: Add _fast_coordinator attribute to hub class

### Issue Description
The `_fast_coordinator` and `_fast_unsub` attributes were referenced throughout the `SAJModbusHub` class but were never initialized in the `__init__` method. This could cause `AttributeError` exceptions when these attributes were accessed.

### Root Cause Analysis
1. **Missing Initialization**: Attributes `_fast_coordinator` and `_fast_unsub` were used in multiple methods but never declared in `__init__`
2. **Affected Methods**:
   - `start_fast_updates()` - checks `if self._fast_coordinator is not None`
   - `restart_fast_updates()` - accesses both attributes for cleanup
   - `async_unload_entry()` - attempts to unsubscribe and cleanup
3. **Potential Error Scenarios**:
   - AttributeError when calling `start_fast_updates()` on first run
   - AttributeError during hub cleanup in `async_unload_entry()`
   - Race conditions during connection settings updates

### Solution Implementation

#### Changes in `hub.py`

Added initialization of both attributes in `SAJModbusHub.__init__()`:

```python
self._fast_coordinator = None
self._fast_unsub = None
```

**Location**: After line 95 (after `self.fast_enabled` initialization)

#### Verification

1. **Initialization Order**: Attributes are now properly initialized before any method that references them can be called
2. **None-Safe Operations**: All methods already have proper None checks, so initialization to None is safe
3. **Lifecycle Management**: Proper cleanup is ensured in `async_unload_entry()`

### Testing Considerations

Should be tested in the following scenarios:
1. ✅ Normal startup with fast coordinator enabled
2. ✅ Normal startup with fast coordinator disabled
3. ✅ Connection settings update triggering restart_fast_updates()
4. ✅ Config entry reload
5. ✅ Integration unload/cleanup

### Code Quality Improvements

This fix follows Python best practices:
- All instance attributes are now declared in `__init__`
- Explicit initialization prevents AttributeError exceptions
- Consistent with other optional attributes in the class

### Related Components

- `__init__.py`: No changes needed (already correctly checks `hub.fast_enabled`)
- `config_flow.py`: No changes needed
- Fast coordinator lifecycle is properly managed

### Credits

- **Reporter**: @quazzie (GitHub PR #121)
- **Analysis & Implementation**: GitHub Copilot / Claude Sonnet 4.5
- **Date**: 2024-11-18

### Commit Message

```
fix: Initialize _fast_coordinator and _fast_unsub attributes in hub

- Add _fast_coordinator = None in SAJModbusHub.__init__()
- Add _fast_unsub = None in SAJModbusHub.__init__()
- Prevents AttributeError when accessing these attributes
- Ensures proper lifecycle management of fast coordinator

Fixes #121
Co-authored-by: quazzie <[email protected]>
```

### Future Considerations

None required. The implementation is complete and follows existing patterns in the codebase.
